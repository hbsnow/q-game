# さめがめオーシャン 実装 TODO

## 🎯 現在の進捗状況（2025-06-12 更新）

### 🚧 実装済み

- **Phase 1**: 基盤システム構築 - **30%完了**
  - ✅ 重力システムの座標同期問題修正
  - ✅ 視覚-論理状態同期の一貫性確保
  - ✅ 列が空になった場合の横スライド機能実装

### 🚧 未実装

- **Phase 1**: 基盤システム構築 - **残り 70%**
  - プロジェクト初期設定、データ構造定義、その他コア機能実装
- **Phase 2**: 基本ゲームシステム - **0%完了**
  - ゲーム画面実装、基本的なさめがめルール、アニメーション
- **Phase 3**: UI/画面システム - **0%完了**
  - 画面遷移システム、全画面実装、画面遷移動線の完成
- **Phase 4**: アイテムシステム - **0%完了**
  - アイテム基盤の実装（ItemManager、ItemEffectManager、GameStateManager）
  - 基本アイテム効果の実装（スワップ、チェンジワン、ミニ爆弾、シャッフル）
- **Phase 5**: ガチャシステム - **0%完了**
  - ガチャ確率計算システムの実装（GachaManager）
  - ガチャ画面の機能実装（実データ連携）
- **Phase 6**: ステージシステム - **0%完了**
  - ステージ設定ファイル実装（StageConfig 型定義と初期データ）
  - ステージ進行管理システム（StageManager）の実装
- **Phase 7**: 妨害ブロックシステム - **0%完了**
  - 妨害ブロック基底クラス（ObstacleBlock）の実装
  - 妨害ブロック描画システム（ObstacleBlockRenderer）の実装

### 🚧 次のステップ

1. **Phase 1**: 基盤システム構築の残り
   - プロジェクト初期設定
   - 基本データ構造定義
   - コア機能実装

## 実装フェーズ

### Phase 1: 基盤システム構築 🏗️

#### 1.1 プロジェクト初期設定

- [ ] Vite でビルド環境構築（vanilla-ts テンプレート）
- [ ] Vitest テスト環境構築
- [ ] Phaser.js インストール・設定
- [ ] TypeScript 設定調整
- [ ] 基本的なディレクトリ構造作成
- [ ] プレースホルダー素材の準備（シンプルな図形・色分け）
- [ ] デバッグ機能の基盤実装

#### 1.2 基本データ構造定義

- [ ] ブロック型定義（Block interface）
- [ ] ゲーム状態管理（GameState）
- [ ] アイテム型定義（Item interface）
- [ ] ステージ設定型定義（StageConfig）
- [ ] 基本データ構造のユニットテスト作成

#### 1.3 コア機能実装

- [ ] ブロック生成ロジック
- [ ] 隣接判定アルゴリズム
- [ ] ブロック消去処理
- [ ] 重力処理（落下アニメーション）
- [ ] スコア計算システム
- [ ] コア機能のユニットテスト作成
- [x] 重力システムの座標同期問題修正
- [x] 包括的な重力処理テストスイート作成
- [x] 視覚-論理状態同期の一貫性確保
- [x] 列が空になった場合の横スライド機能実装

### Phase 2: 基本ゲームシステム 🎮

#### 2.1 ゲーム画面実装

- [ ] 10×14 ゲーム盤面の描画
- [ ] ブロックの視覚表現（6 色対応）
- [ ] タッチ/クリック入力処理
- [ ] ブロック選択・消去の UI

#### 2.2 ゲームロジック実装

- [ ] さめがめルール実装（同色隣接ブロック消去）
- [ ] 全消し判定ロジック
- [ ] ステージクリア判定（目標スコア達成検出）
- [ ] ステージクリア後の次ステージ移行処理
- [ ] 連打防止機能（得点重複加算防止）
- [ ] 行き詰まり状態の検出（消去可能ブロックなし）

#### 2.3 基本アニメーション

- [ ] ブロック消去エフェクト
- [ ] ブロック落下アニメーション
- [ ] 左寄せアニメーション
- [ ] スコア表示アニメーション

#### 2.4 ユーザーインターフェース改善

- [ ] ホバーフィードバック（色弱対応・脈動エフェクト）
- [ ] 処理中の視覚的フィードバック
- [ ] アニメーション速度最適化

### Phase 3: UI/画面システム 📱

#### 3.1 画面遷移システム

- [ ] Phaser Scene 管理
- [ ] 画面間データ受け渡し
- [ ] 画面遷移の基盤実装

#### 3.2 基本画面実装（モックデータ使用）

- [ ] タイトル画面
- [ ] メイン画面（ステージ選択）
- [ ] アイテム選択画面（モックアイテムデータ使用）
- [ ] ゲーム画面（基本機能のみ）
- [ ] リザルト画面（モックスコアデータ使用）
- [ ] アイテム一覧画面（モックアイテムデータ使用）
- [ ] ガチャ画面（モック確率表示）
- [ ] ガチャ結果画面（モックアイテム表示）
- [ ] ゲームクリア画面

#### 3.3 画面遷移動線の実装

- [ ] タイトル画面 → メイン画面（ゲーム開始ボタン）
- [ ] メイン画面 → アイテム選択画面（プレイボタン）
- [ ] メイン画面 → アイテム一覧画面（アイテムボタン）
- [ ] メイン画面 → ガチャ画面（ガチャボタン）
- [ ] アイテム選択画面 → ゲーム画面（決定ボタン）
- [ ] アイテム選択画面 → メイン画面（キャンセルボタン）
- [ ] ゲーム画面 → リザルト画面（ステージクリア/リタイア）
- [ ] ゲーム画面 → メイン画面（リタイアボタン）
- [ ] リザルト画面 → アイテム選択画面（次ステージ/リトライ）
- [ ] リザルト画面 → メイン画面（メイン画面ボタン）
- [ ] リザルト画面 → ゲームクリア画面（最終ステージクリア時）
- [ ] ガチャ画面 → ガチャ結果画面（ガチャ実行）
- [ ] ガチャ結果画面 → ガチャ画面（もう一度/戻る）
- [ ] ガチャ画面 → メイン画面（戻るボタン）
- [ ] アイテム一覧画面 → メイン画面（戻るボタン）
- [ ] ゲームクリア画面 → タイトル画面（タイトルへ戻る）

#### 3.4 UI コンポーネント

- [ ] ボタンコンポーネント
- [ ] スコア表示
- [ ] ゴールド表示
- [ ] ステージ情報表示

### Phase 4: アイテムシステム 🎒

#### 4.1 アイテム基盤

- [ ] アイテムデータ管理
- [ ] アイテム所持システム
- [ ] アイテム装備システム

#### 4.2 基本アイテム実装

- [ ] スワップ（ブロック入れ替え）
- [ ] チェンジワン（1 個色変更）
- [ ] ミニ爆弾（1 個消去）
- [ ] シャッフル（盤面再配置）

#### 4.3 アイテム選択画面の機能実装

- [ ] 装備枠システム（特殊枠・通常枠）
- [ ] 装備制限ロジック
- [ ] アイテム使用状態の管理
- [ ] モックデータから実データへの置き換え

### Phase 5: ガチャシステム 🎰

#### 5.1 ガチャ基盤

- [ ] ガチャ確率計算システム
- [ ] アイテム排出ロジック
- [ ] ゴールド管理システム
- [ ] ガチャシステムのユニットテスト作成

#### 5.2 ガチャ UI 実装

- [ ] モックデータから実データへの置き換え
- [ ] ガチャ演出（宝箱アニメーション）
- [ ] ガチャ結果演出

#### 5.3 ガチャ機能

- [ ] 1 回ガチャ
- [ ] 10 連ガチャ
- [ ] 10 連ガチャ確定演出（最低 1 つ D 以上確定）
- [ ] 確率表示機能
- [ ] 10 連ガチャの表示バグ修正（集約アイテムの展開）
- [ ] ガチャ関連画面のデバッグライン追加

### Phase 6: ステージシステム 🏔️

#### 6.1 ステージ管理

- [ ] ステージ設定ファイル実装
- [ ] ステージ進行管理
- [ ] ゲーム状態の初期化処理
- [ ] ページリロード時のリセット処理
- [ ] 進行状況保存なしの確認（完全リセット方式）

#### 6.2 初期ステージ実装

- [ ] ステージ 1-10 の実装
- [ ] 色数変化システム
- [ ] 目標スコア管理

### Phase 7: 妨害ブロックシステム 🧊

#### 7.1 妨害ブロック基盤

- [ ] 妨害ブロック基底クラス
- [ ] 妨害ブロック描画システム
- [ ] 妨害ブロック判定ロジック

#### 7.2 基本妨害ブロック実装

- [ ] 氷結 Lv1（隣接消去で解除）
- [ ] カウンター+（指定数以上で消去）
- [ ] 氷結 Lv2（2 回隣接消去で解除）
- [ ] カウンター（ちょうど指定数で消去）

#### 7.3 高度な妨害ブロック

- [ ] 氷結カウンター+
- [ ] 岩ブロック（アイテムでのみ消去）
- [ ] 氷結カウンター
- [ ] 鋼鉄ブロック（固定、特殊アイテムでのみ消去）

### Phase 8: 高度なアイテム実装 ⚡

#### 8.1 中級アイテム

- [ ] 溶解剤（氷結解除）
- [ ] チェンジエリア（エリア色変更）
- [ ] カウンター+リセット
- [ ] アドプラス（カウンター変換）

#### 8.2 上級アイテム

- [ ] 爆弾（3×3 範囲消去）
- [ ] スコアブースター（1.5 倍）
- [ ] ハンマー（岩ブロック破壊）
- [ ] 鋼鉄ハンマー（鋼鉄ブロック破壊）
- [ ] スペシャルハンマー（全ブロック破壊）

### Phase 9: エフェクト・演出強化 ✨

#### 9.1 視覚エフェクト

- [ ] パーティクルシステム
- [ ] ブロック消去エフェクト強化
- [ ] 全消しボーナス演出
- [ ] レアアイテム獲得演出

#### 9.2 音響システム

- [ ] 効果音システム
- [ ] BGM システム
- [ ] 音量調整機能

#### 9.3 UI/UX 改善

- [ ] ローディング画面
- [ ] エラーハンドリング実装
- [ ] ツールチップ・ヘルプ機能

#### 9.4 デバッグ機能実装

- [ ] デバッグライン表示機能（DebugHelper）
- [ ] ステージスキップ機能（UI ボタン）
- [ ] 開発時のデバッグ情報表示
- [ ] チートコード実装（アイテム追加など）
- [ ] デバッグモードの切り替え機能
- [ ] ゲーム状態の可視化（盤面データ、スコア詳細など）
- [ ] パフォーマンス監視機能
- [ ] ログ出力システム

#### 9.5 エラーハンドリング詳細

- [ ] ガチャ時のゴールド不足エラー処理
- [ ] アイテム装備制限エラー処理
- [ ] 無効操作時のエラーメッセージ表示
- [ ] アイテム所持上限到達時の処理
- [ ] データ不整合時の復旧処理
- [ ] 消去不可能状態の検出・対処
- [ ] 予期しないエラーの汎用処理

### Phase 10: アセット制作・最終仕上げ 🎨

#### 10.1 画像素材制作・差し替え

- [ ] ブロック画像（6 色 + 妨害ブロック）
- [ ] UI 要素（ボタン、枠、装飾）
- [ ] 背景画像（海のテーマ）
- [ ] アイテムアイコン
- [ ] エフェクト画像

#### 10.2 音響素材制作・実装

- [ ] BGM 制作・実装
- [ ] 効果音制作・実装
- [ ] 環境音制作・実装

### Phase 11: 最終調整・完成 🎯

#### 11.1 バランス調整

- [ ] ステージ難易度調整
- [ ] ガチャ確率微調整
- [ ] アイテム効果バランス調整

#### 11.2 品質向上

- [ ] バグ修正
- [ ] パフォーマンス最適化
- [ ] ブラウザ互換性確認
- [ ] テストカバレッジ向上

#### 11.3 最終機能

- [ ] チュートリアル実装
- [ ] 最終テスト・デバッグ

## 実装優先度

### 🔥 最高優先度（Phase 1-3）

基本的なゲームが動作する最小限の機能

### ⚡ 高優先度（Phase 4-6）

ゲームとして成立するために必要な機能

### 📈 中優先度（Phase 7-8）

ゲームの深みを増す機能

### 🎨 最低優先度（Phase 9-11）

ユーザー体験を向上させる機能とアセット制作

## 開発アプローチ

### 🖥️ 画面ファーストアプローチ

- **Phase 3 で全画面を先行実装**: モックデータを使用して画面の見た目と遷移を完成
- **Phase 4 以降でロジック実装**: 実際のデータ処理システムを構築
- **段階的な置き換え**: モックデータから実データへの段階的な置き換え

### 📋 モックデータの例

```typescript
// Phase 3で使用するモックデータ
const mockItems = [
  { id: "swap", name: "スワップ", count: 3, rarity: "E" },
  { id: "bomb", name: "爆弾", count: 1, rarity: "S" },
];

const mockGameState = {
  currentStage: 5,
  gold: 1250,
  score: 0,
  targetScore: 500,
};
```

## 注意事項

- 各フェーズは前のフェーズが完了してから開始
- **テスト駆動開発（TDD）**: 先にテストを書いてから実装
- 基本機能の動作確認を優先し、段階的に機能追加
- **重要なロジックには必ずユニットテストを作成**
- ステージ 11 以降の詳細仕様は Phase 7 開始時に決定
- パフォーマンス問題が発生した場合は適宜最適化を実施

## テスト戦略

### ユニットテスト対象

- ゲームロジック（ブロック消去、スコア計算など）
- データ構造・型定義
- ガチャ確率計算
- アイテム効果処理

### テストツール

- **Vitest**: 高速なユニットテスト
- **テスト駆動開発（TDD）**: 先にテストを書いてから実装

### テスト方針

- Phaser.js の Canvas/WebGL 部分はテスト対象外
- 純粋なロジック部分のみをテスト
- モックを活用して Phaser 依存部分を分離
