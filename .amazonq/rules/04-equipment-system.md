# 装備システムのルール

## アイテム装備と使用の基本原則

### ステージごとの独立性
- **各ステージは独立**: 装備と使用状態はステージごとにリセットされる
- **前のステージの影響なし**: 前のステージで使用したアイテムが次のステージで「使用済み」になることはない
- **新規装備選択**: 各ステージ開始前に、アイテム選択画面で新たに装備を選択する

### 使用済み状態の管理
- **使用済み状態の範囲**: 「使用済み」状態は現在プレイ中のステージ内でのみ有効
- **ステージ終了時のリセット**: ステージをクリアまたはリトライすると、使用済み状態はリセットされる
- **視覚的表現**: 使用済みアイテムはグレーアウトやオーバーレイで表示

### アイテムの消費タイミング
- **装備時の消費なし**: アイテムを装備しただけでは所持数は減らない
- **使用時の消費なし**: アイテムを使用した時点でも、まだ所持数は減らない
- **ステージ終了時の消費**: ステージクリア時に、使用したアイテムの所持数が減少する
- **未使用アイテムの保存**: 装備したが使用しなかったアイテムは所持数が減らない

## 具体的な動作フロー

1. **アイテム選択画面**:
   - プレイヤーは所持アイテムから装備するアイテムを選択
   - 特殊枠と通常枠にそれぞれ1つずつ装備可能
   - この時点では所持数は減らない

2. **ゲームプレイ中**:
   - 装備したアイテムを使用すると「使用済み」状態になる
   - 使用済みアイテムは同じステージ内で再使用できない
   - この時点でもまだ所持数は減らない

3. **ステージクリア時**:
   - 使用したアイテムの所持数が減少（1アイテムにつき1個）
   - 使用しなかったアイテムは所持数が減らない
   - 次のステージでは使用状態がリセットされる

4. **ステージリトライ時**:
   - 使用状態がリセットされる
   - 所持数は減らない（未クリアのため）
   - 再度同じアイテムを使用可能

## 装備制限の詳細

- **特殊枠**: S・Aレアアイテムを装備可能、通常アイテム（B〜Fレア）も装備可能
- **通常枠**: B〜Fレアアイテムのみ装備可能、S・Aレアアイテムは装備不可
- **戦略的選択**: 特殊枠に通常アイテムを装備することで、貴重なS・Aレアアイテムを温存する戦略も有効

## 実装上の注意点

- **使用済み状態の管理**: 各ステージ内でのみ有効な使用済み状態を適切に管理する
- **ステージ間の独立性**: ステージ間で使用状態が引き継がれないようにする
- **所持数の減少タイミング**: ステージクリア時にのみ所持数を減少させる
- **視覚的フィードバック**: 使用済みアイテムの状態を明確に表示する

## 開発者向け実装ガイド

```typescript
// ステージ開始時
function onStageStart() {
  // 使用済みアイテムリストをリセット
  gameState.usedItems = [];
}

// アイテム使用時
function useItem(itemId: string) {
  // 使用済みとしてマーク（所持数はまだ減らさない）
  gameState.usedItems.push(itemId);
  
  // 使用済み表示に更新
  updateItemDisplay(itemId, 'used');
}

// ステージクリア時
function onStageClear() {
  // 使用したアイテムの所持数を減らす
  for (const itemId of gameState.usedItems) {
    decreaseItemCount(itemId, 1);
  }
  
  // 使用済みアイテムリストをリセット
  gameState.usedItems = [];
}

// ステージリトライ時
function onStageRetry() {
  // 使用済みアイテムリストをリセットするだけ（所持数は減らさない）
  gameState.usedItems = [];
}
```
