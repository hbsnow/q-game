# ゲームの基本ルール

## 1. ブロックの基本構造

### 1.1 ブロックの型定義

```typescript
interface Block {
  x: number; // グリッド上のX座標
  y: number; // グリッド上のY座標
  color: string; // 色（HEX形式）
  type: string; // ブロックタイプ（'normal', 'iceLv1'など）
}
```

### 1.2 ブロックの論理状態と視覚表現の分離

- **論理状態**: `Block`オブジェクトの配列（`blocks[][]`）で管理
- **参照関係**: 論理状態から視覚表現への参照（`block.sprite`）を持つ
- **重要**: 視覚表現から論理状態への直接参照は持たない（一方向の参照関係）

## 2. ブロックのアスキーアート表現

### フレーム

- フレームには `+` `-` `|` を使う
- 列には名前をつけて、アルファベットの小文字を左から a から始める
- 行にも名前をつけて、数字で上から 0 から始める

```txt
     a   b   c   d
  +-----------------+
0 |                 |
1 |                 |
2 |                 |
3 |                 |
  +-----------------+
```

### ブロック

#### ノーマルブロック

ブロックの色は次の通りアルファベット大文字 1 つで表現する。

- `B`: **深い青** (#1E5799)
- `L`: **水色** (#7DB9E8)
- `G`: **海緑** (#2E8B57)
- `R`: **珊瑚赤** (#FF6347)
- `Y`: **砂金色** (#F4D03F)
- `W`: **真珠白** (#F5F5F5)

通常のノーマルブロックの場合、`__`を先頭に付与する。

```txt
     a   b   c   d
  +-----------------+
0 | __R __R __B __Y |
1 | __B __R __B __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
```

#### 妨害ブロック

- `*`: 氷結ブロック LV1
- `**`: 氷結ブロック LV2
- `+`: カウンター+ブロック
- `-`: カウンター-ブロック
- `*+`: 氷結カウンター+ブロック
- `*-`: 氷結カウンター-ブロック
- `<_>`: 岩ブロック
- `<->`: 鋼鉄ブロック

```txt
     a   b   c   d
  +-----------------+
0 | _*R _+R _=B *+Y |
1 | *=B <-> __B __Y |
2 | __B __R <_> __Y |
3 | __Y __Y __R __R |
  +-----------------+
```

## 3. ブロック消去のルール

### 通常消去

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y __R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B         __Y |
1 | __Y         __Y |
2 | __B     __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
```

### 下に空白ができたとき落下する

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __B __Y |
1 | __R __R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 |             __Y |
1 | __B     __B __Y |
2 | __B     __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
```

### 列すべてからブロックがなくなったとき、左にスライドする

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __B __Y |
1 | __R __R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __R __R __R |
  +-----------------+

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 |                 |
1 | __B     __Y     |
2 | __B __B __Y     |
3 | __Y __Y __Y     |
  +-----------------+
```

## 4. 妨害ブロック

### 氷結ブロック LV1

- 隣接する同色ブロックが 1 回消去されると解除されてノーマルブロックに戻る
- ノーマルブロックに戻ったとき下に空白があると重力によって落下する
- 氷結ブロック自身はクリックできない

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y _*R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B         __Y |
1 | __Y         __Y |
2 | __B     __Y __Y |
3 | __Y __R __B __R |
  +-----------------+
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R _*R __R |
1 | __Y __R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __R __R __R |
  +-----------------+

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B             |
1 | __Y             |
2 | __B __R __Y     |
3 | __Y __Y __Y     |
  +-----------------+
// 落下して、b列がすべて消えたので左にスライド
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __R |
1 | __Y __R __R __Y |
2 | __B _*B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+

ユーザーがa2をタップ:
     a   b   c   d
  +-----------------+
0 |     __R __R __R |
1 | __B __R __R __Y |
2 | __Y __B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+
// ノーマルブロックと氷結ブロックの2つでもタップ可能
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __R |
1 | __Y __R __R __Y |
2 | __B _*B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+

ユーザーがb2をタップ:
     a   b   c   d
  +-----------------+
0 |     __R __R __R |
1 | __B __R __R __Y |
2 | __Y __B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+
// 氷結ブロックはタップ不可なので何も起こらない
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __R |
1 | __Y __R __R __Y |
2 | _*B _*B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+

ユーザーがa2をタップ:
     a   b   c   d
  +-----------------+
0 | __B __R __R __R |
1 | __Y __R __R __Y |
2 | _*B _*B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+
// 氷結ブロック2つでは氷結ブロックがタップ不可なので何も発生しない
```

### 氷結ブロック LV2

- 隣接する同色ブロックが 1 回消去されると解除されて氷結ブロック LV1 に変化する
- 氷結ブロック LV1 に戻ったとき下に空白があると重力によって落下する
- 氷結ブロック自身はクリックできない

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y **R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B         __Y |
1 | __Y         __Y |
2 | __B     __Y __Y |
3 | __Y _*R __B __R |
  +-----------------+
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R **R __Y |
1 | __Y __R __R __R |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B             |
1 | __Y _*R __Y     |
2 | __B __Y __Y     |
3 | __Y __B __R     |
  +-----------------+
// 落下して、b列がすべて消えたので左にスライド
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R **R __Y |
1 | __Y __R __R __R |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+

ユーザーがc0をタップ:
     a   b   c   d
  +-----------------+
0 | __B __R **R __Y |
1 | __Y __R __R __R |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+
// 氷結ブロックはタップ不可なので何も起こらない
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __R |
1 | __Y __R __R __Y |
2 | __B **B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+

ユーザーがa2をタップ:
     a   b   c   d
  +-----------------+
0 |     __R __R __R |
1 | __B __R __R __Y |
2 | __Y _*B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+
// ノーマルブロックと氷結ブロックの2つでもタップ可能
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __R |
1 | __Y __R __R __Y |
2 | _*B **B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+

ユーザーがa2をタップ:
     a   b   c   d
  +-----------------+
0 | __B __R __R __R |
1 | __Y __R __R __Y |
2 | _*B **B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+
// 氷結ブロックはタップ不可なので何も起こらない
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __R |
1 | __Y __R __R __Y |
2 | **B **B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+

ユーザーがa2をタップ:
     a   b   c   d
  +-----------------+
0 | __B __R __R __R |
1 | __Y __R __R __Y |
2 | **B **B __Y __Y |
3 | __Y __R __R __R |
  +-----------------+
// 氷結ブロックはタップ不可なので何も起こらない
```

### カウンター+ブロック

- 指定数以上の同色ブロックグループで消去可能
- 指定数未満であればブロックはそのままなにも起こらない
- カウンター+ブロック自身はクリックできない

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y _+R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// b1の_+Rのカウンター+ブロックの値が3

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B         __Y |
1 | __Y         __Y |
2 | __B     __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y _+R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// b1の_+Rのカウンター+ブロックの値が5

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B         __Y |
1 | __Y         __Y |
2 | __B     __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// 値が5でちょうど5つでもブロックは消える
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __B __Y |
1 | __Y _+R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+
// b1の_+Rのカウンター+ブロックの値が6

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B         __Y |
1 | __Y     __B __Y |
2 | __B     __Y __Y |
3 | __Y _+R __B __R |
  +-----------------+
// 値が6で5つ消してもブロックは消えない
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y _+R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+

ユーザーがb1をタップ:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y _+R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// カウンター+ブロックはタップ不可なので何も起こらない
```

### カウンター-ブロック

- 指定数以下の同色ブロックグループで消去可能
- 指定数より大きいブロックはそのままなにも起こらない
- カウンター-ブロック自身はクリックできない

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y _-R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+
// b1の_+Rのカウンター-ブロックの値が7

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B     __Y     |
1 | __Y     __Y     |
2 | __B __Y __Y     |
3 | __Y __B __R     |
  +-----------------+
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y _-R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+
// b1の_+Rのカウンター-ブロックの値が6

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B     __Y     |
1 | __Y     __Y     |
2 | __B __Y __Y     |
3 | __Y __B __R     |
  +-----------------+
// 値が6でちょうど6つでもブロックは消える
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y _-R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+
- b1の_+Rのカウンター-ブロックの値が3

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B         __Y |
1 | __Y         __Y |
2 | __B     __Y __Y |
3 | __Y _-R __B __R |
  +-----------------+
// 値が3で6つ消してもブロックは消えない
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y _-R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+
- b1の_+Rのカウンター-ブロックの値が3

ユーザーがb1をタップ:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y _-R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __R __B __R |
  +-----------------+
// カウンター-ブロックはタップ不可なので何も起こらない
```

### 氷結カウンター+ブロック

- 氷結が解除されるとノーマルブロックになる
- 指定数未満であればブロックは氷結のみ解除され、カウンター+ブロックになる
- 氷結カウンター+自身はクリックできない

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y *+R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// b1の_+Rのカウンター+ブロックの値が3

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B         __Y |
1 | __Y         __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y *+R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// b1の_+Rのカウンター+ブロックの値が5

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B         __Y |
1 | __Y         __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// 値が5でちょうど5つでもブロックはノーマルブロックになる
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y *+R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// b1の_+Rのカウンター+ブロックの値が6

ユーザーがb0をタップ:
     a   b   c   d
  +-----------------+
0 | __B         __Y |
1 | __Y         __Y |
2 | __B _+R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// 値が6であれば氷結のみが解除されカウンター+ブロックになる
```

```txt
初期状態:
     a   b   c   d
  +-----------------+
0 | __B __R __R __Y |
1 | __Y *+R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// b1の_+Rのカウンター+ブロックの値が6

ユーザーがb1をタップ:
  +-----------------+
0 | __B __R __R __Y |
1 | __Y *+R __R __Y |
2 | __B __R __Y __Y |
3 | __Y __Y __R __R |
  +-----------------+
// 氷結カウンター+ブロックはタップ不可なので何も起こらない
```

### 氷結カウンター-ブロック

- 氷結カウンター+ブロックのルールからカウンター+のルールをカウンター-にしたものと同様になります

## 4. 登場する妨害ブロック（ステージ進行で追加）

### 初登場ステージ

- 氷結 Lv1: 11
- カウンター+: 21
- 氷結 Lv2: 31
- カウンター-: 41
- 氷結カウンター+: 51
- 岩ブロック: 61
- 氷結カウンター-: 71
- 鋼鉄ブロック: 81
