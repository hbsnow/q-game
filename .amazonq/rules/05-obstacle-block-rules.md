# 妨害ブロック実装ルール

## 1. 基本概念

### 1.1 妨害ブロックの定義

- 妨害ブロックとは、通常ブロックとは異なる特殊な性質を持つブロックである
- 各マスには通常ブロックか妨害ブロックのどちらか一方のみが存在する
- 妨害ブロックは「オーバーレイ」ではなく「単一のエンティティ」として扱う

### 1.2 重要な原則

- **単一エンティティの原則**: 妨害ブロックの下に通常ブロックが存在することはない
- **マス占有の原則**: 1 つのマスには 1 種類のブロックのみ存在する
- **視覚的一貫性**: 妨害ブロックは見た目でも単一のブロックとして表現する

### 1.3 ブロック連結判定の原則

- **通過可能性の原則**: 氷結系ブロックは同色ブロックの連結判定において「通過可能」である
- **グループ形成の原則**: 氷結系ブロックは連結判定では通過可能だが、消去グループには含まれない
- **カウンター系の参加原則**: カウンター系ブロックはグループ形成に参加し、消去グループに含まれる

## 2. 妨害ブロックの種類と特性

### 2.1 氷結ブロック

- **氷結 Lv1**: 隣接する同色ブロックが 1 回消去されると解除される
- **氷結 Lv2**: 隣接する同色ブロックが 2 回消去されると解除される
- **視覚表現**: 青みがかった色で氷の質感を表現し、氷の結晶パターンを描画

#### 2.1.1 氷結 Lv1 の動作例

```
初期状態:
    a b c
  ┌─────┐
0 │_R ❄R _B│  _R: 赤の通常ブロック
1 │_R _B _B│  ❄R: 赤の氷結Lv1ブロック
2 │_Y _Y _G│  _B: 青の通常ブロック
  └─────┘  _Y: 黄の通常ブロック
             _G: 緑の通常ブロック

ステップ1: 位置(a,0)と(a,1)の赤ブロックを消去
    a b c
  ┌─────┐
0 │   ❄R _B│  ❄R: 赤の氷結Lv1ブロック
1 │   _B _B│  _B: 青の通常ブロック
2 │_Y _Y _G│  _Y: 黄の通常ブロック
  └─────┘  _G: 緑の通常ブロック

ステップ2: 氷結ブロックの隣で同色(赤)のブロックが消去されたため、氷結が解除される
    a b c
  ┌─────┐
0 │   _R _B│  _R: 赤の通常ブロック (氷結解除)
1 │   _B _B│  _B: 青の通常ブロック
2 │_Y _Y _G│  _Y: 黄の通常ブロック
  └─────┘  _G: 緑の通常ブロック

// 注: 氷結が解除されて通常ブロックになっただけでは、ブロックは落下しません。
// ブロックが落下するのは、そのブロックの下に空きマスがある場合のみです。
```

#### 2.1.2 氷結 Lv2 の動作例

```
初期状態:
    a b c
  ┌─────┐
0 │_R ❅R _B│  _R: 赤の通常ブロック
1 │_R _B _B│  ❅R: 赤の氷結Lv2ブロック
2 │_Y _R _G│  _B: 青の通常ブロック
  └─────┘  _Y: 黄の通常ブロック
             _R: 赤の通常ブロック
             _G: 緑の通常ブロック

ステップ1: 位置(a,0)と(a,1)の赤ブロックを消去
    a b c
  ┌─────┐
0 │   ❅R _B│  ❅R: 赤の氷結Lv2ブロック
1 │   _B _B│  _B: 青の通常ブロック
2 │_Y _R _G│  _Y: 黄の通常ブロック
  └─────┘  _R: 赤の通常ブロック
             _G: 緑の通常ブロック

ステップ2: 氷結ブロックの隣で同色(赤)のブロックが消去されたため、氷結Lv2→Lv1に変化
    a b c
  ┌─────┐
0 │   ❄R _B│  ❄R: 赤の氷結Lv1ブロック (Lv2→Lv1)
1 │   _B _B│  _B: 青の通常ブロック
2 │_Y _R _G│  _Y: 黄の通常ブロック
  └─────┘  _R: 赤の通常ブロック
             _G: 緑の通常ブロック

ステップ3: 位置(c,0)と(b,1)と(c,1)の青ブロックを消去し、氷結ブロックが落下
    a b c
  ┌─────┐
0 │       │
1 │   ❄R   │  ❄R: 赤の氷結Lv1ブロック (落下後)
2 │_Y _R _G│  _Y: 黄の通常ブロック
  └─────┘  _R: 赤の通常ブロック
             _G: 緑の通常ブロック

ステップ4: 位置(b,2)の赤ブロックを消去し、氷結が解除されて通常ブロックになり落下
    a b c
  ┌─────┐
0 │       │
1 │       │
2 │_Y _R _G│  _Y: 黄の通常ブロック
  └─────┘  _R: 赤の通常ブロック (氷結解除後、落下)
             _G: 緑の通常ブロック
```

### 2.2 カウンターブロック

- **カウンター**: ちょうど指定数の同色ブロックグループで消去可能
- **カウンター+**: 指定数以上の同色ブロックグループで消去可能
- **視覚表現**: ブロック自体の色に円形のカウンター表示を組み込む

#### 2.2.1 カウンターブロックの動作例

```
初期状態:
    a b c
  ┌─────┐
0 │_R cR _B│  _R: 赤の通常ブロック
1 │_R _B _B│  cR: 赤のカウンターブロック(値=3)
2 │_Y _Y _G│  _B: 青の通常ブロック
  └─────┘  _Y: 黄の通常ブロック
             _G: 緑の通常ブロック

ケース1: 位置(a,0)と(a,1)と(b,0)の赤ブロック3つを選択（ちょうど3つ）
    a b c
  ┌─────┐
0 │_R cR _B│  選択した赤ブロック3つ（カウンターブロック含む）
1 │_R _B _B│  カウンター値=3に一致するため消去可能
2 │_Y _Y _G│
  └─────┘

結果: 3つのブロックが消去される
    a b c
  ┌─────┐
0 │      _B│
1 │      _B│
2 │_Y _Y _G│
  └─────┘

ケース2: 位置(a,0)と(b,0)の赤ブロック2つを選択（3より少ない）
    a b c
  ┌─────┐
0 │_R cR _B│  選択した赤ブロック2つ
1 │_R _B _B│  カウンター値=3より少ないためカウンターブロックは消去されない
2 │_Y _Y _G│
  └─────┘

結果: 通常の赤ブロックは消去されるが、カウンターブロックは残る
    a b c
  ┌─────┐
0 │   cR _B│  カウンターブロックは残る
1 │   _B _B│  隣接する通常の赤ブロックも消去される
2 │_Y _Y _G│
  └─────┘

ケース3: 位置(a,0)と(a,1)と(b,0)と新たに追加された赤ブロックの4つを選択
    a b c
  ┌─────┐
0 │_R cR _B│  選択した赤ブロック4つ
1 │_R _B _B│  カウンター値=3より多いため消去不可
2 │_R _Y _G│  (新たに追加された赤ブロック)
  └─────┘

結果: 通常の赤ブロックは消去されるが、カウンターブロックは残る
    a b c
  ┌─────┐
0 │   cR _B│  カウンターブロックは残る
1 │   _B _B│  隣接する通常の赤ブロックは消去される
2 │   _Y _G│
  └─────┘
```

#### 2.2.2 カウンター+ブロックの動作例

```
初期状態:
    a b c
  ┌─────┐
0 │_R c+R _B│  _R: 赤の通常ブロック
1 │_R _B _B│  c+R: 赤のカウンター+ブロック(値=3+)
2 │_Y _Y _G│  _B: 青の通常ブロック
  └─────┘  _Y: 黄の通常ブロック
             _G: 緑の通常ブロック

ケース1: 位置(a,0)と(a,1)と(b,0)の赤ブロック3つを選択（ちょうど3つ）
    a b c
  ┌─────┐
0 │_R c+R _B│  選択した赤ブロック3つ（カウンター+ブロック含む）
1 │_R _B _B│  カウンター値=3+に一致するため消去可能
2 │_Y _Y _G│
  └─────┘

結果: 3つのブロックが消去される
    a b c
  ┌─────┐
0 │      _B│
1 │   _B _B│
2 │_Y _Y _G│
  └─────┘

ケース2: 位置(a,0)と(b,0)の赤ブロック2つを選択（3より少ない）
    a b c
  ┌─────┐
0 │_R c+R _B│  選択した赤ブロック2つ
1 │_B _B _B│  カウンター値=3+より少ないためカウンター+ブロックは消去されない
2 │_Y _Y _G│
  └─────┘

結果: 通常の赤ブロックは消去されるが、カウンター+ブロックは残る
    a b c
  ┌─────┐
0 │   c+R _B│  カウンター+ブロックは残る
1 │_B _B _B│  隣接する通常の赤ブロックは消去される
2 │_Y _Y _G│
  └─────┘

ケース3: 位置(a,0)と(a,1)と(b,0)と新たに追加された赤ブロックの4つを選択
    a b c
  ┌─────┐
0 │_R c+R _B│  選択した赤ブロック4つ
1 │_R _B _B│  カウンター値=3+以上のため消去可能
2 │_R _Y _G│  (新たに追加された赤ブロック)
  └─────┘

結果: 4つのブロックが消去される（カウンター値以上なので消去可能）
    a b c
  ┌─────┐
0 │      _B│
1 │   _B _B│
2 │    _Y _G│
  └─────┘
```

### 2.3 複合妨害ブロック

- **氷結カウンター**: 氷結が解除されるとカウンターブロックになる
- **氷結カウンター+**: 氷結が解除されるとカウンター+ブロックになる
- **視覚表現**: 青みがかった色と氷の結晶パターンにカウンター表示を組み込む

#### 2.3.1 氷結カウンターブロックの動作例

```
初期状態:
    a b c
  ┌─────┐
0 │_R ❄cR _B│  _R: 赤の通常ブロック
1 │_R _B _B│  ❄cR: 赤の氷結カウンターブロック(値=3)
2 │_Y _Y _G│  _B: 青の通常ブロック
  └─────┘  _Y: 黄の通常ブロック
             _G: 緑の通常ブロック

ステップ1: 位置(a,0)と(a,1)の赤ブロックを消去
    a b c
  ┌─────┐
0 │   ❄cR _B│  ❄cR: 赤の氷結カウンターブロック
1 │   _B _B│  _B: 青の通常ブロック
2 │_Y _Y _G│  _Y: 黄の通常ブロック
  └─────┘  _G: 緑の通常ブロック

ステップ2: 氷結ブロックの隣で同色(赤)のブロックが消去されたため、氷結とカウンターが同時に解除されて通常ブロックになる
    a b c
  ┌─────┐
0 │   _R _B│  _R: 赤の通常ブロック (位置(b,0)の氷結カウンターが解除されて通常ブロックに)
1 │   _B _B│  _B: 青の通常ブロック
2 │_Y _Y _G│  _Y: 黄の通常ブロック
  └─────┘  _G: 緑の通常ブロック
  └─────┘
```

#### 2.3.2 氷結カウンター+ブロックの動作例

```
初期状態:
    a b c
  ┌─────┐
0 │_R ❄c+R _B│  _R: 赤の通常ブロック
1 │_R _B _B│  ❄c+R: 赤の氷結カウンター+ブロック(値=3+)
2 │_Y _Y _G│  _B: 青の通常ブロック
  └─────┘  _Y: 黄の通常ブロック
             _G: 緑の通常ブロック

ステップ1: 位置(a,0)と(a,1)の赤ブロックを消去
    a b c
  ┌─────┐
0 │   ❄c+R _B│  ❄c+R: 赤の氷結カウンター+ブロック
1 │   _B _B│  _B: 青の通常ブロック
2 │_Y _Y _G│  _Y: 黄の通常ブロック
  └─────┘  _G: 緑の通常ブロック

ステップ2: 氷結ブロックの隣で同色(赤)のブロックが消去されたため、氷結とカウンター+が同時に解除されて通常ブロックになる
    a b c
  ┌─────┐
0 │   _R _B│  _R: 赤の通常ブロック (位置(b,0)の氷結カウンター+が解除されて通常ブロックに)
1 │   _B _B│  _B: 青の通常ブロック
2 │_Y _Y _G│  _Y: 黄の通常ブロック
  └─────┘  _G: 緑の通常ブロック
```

### 2.4 特殊妨害ブロック

- **岩ブロック**: アイテムでのみ消去可能、重力の影響を受ける
- **鋼鉄ブロック**: 特殊アイテムでのみ消去可能、重力の影響を受けない
- **視覚表現**: それぞれ岩や鋼鉄の質感を持つ単一のブロックとして表現

#### 2.4.1 岩ブロックの動作例

```
初期状態:
    a b c
  ┌─────┐
0 │_R ◆  _B│  _R: 赤の通常ブロック
1 │_R _B _B│  ◆ : 岩ブロック
2 │_Y _Y _G│  _B: 青の通常ブロック
  └─────┘  _Y: 黄の通常ブロック
             _G: 緑の通常ブロック

ケース1: 通常操作での消去試行
    a b c
  ┌─────┐
0 │_R ◆  _B│  岩ブロックは通常操作では消去できない
1 │_R _B _B│  隣接する赤ブロックを選択しても、岩ブロックは
2 │_Y _Y _G│  グループ形成に参加しない
  └─────┘

結果: 岩ブロックは消去されず、赤ブロックのみ消去される
    a b c
  ┌─────┐
0 │   ◆  _B│
1 │   _B _B│
2 │_Y _Y _G│
  └─────┘

ケース2: ハンマーアイテムの使用
    a b c
  ┌─────┐
0 │_R _B  _B│  ハンマーアイテムを岩ブロックに使用
1 │_R ◆ _B│
2 │_Y _Y _G│
  └─────┘

結果: 岩ブロックが消去される
    a b c
  ┌─────┐
0 │_R    _B│
1 │_R _B _B│
2 │_Y _Y _G│
  └─────┘

ケース3: 重力の影響
    a b c
  ┌─────┐
0 │_R ◆  _B│
1 │_R _B _B│  青ブロックを消去
2 │_Y _Y _G│
  └─────┘

結果: 岩ブロックは重力の影響を受けて落下する
    a b c
  ┌─────┐
0 │_R      │
1 │_R ◆   │  岩ブロックが落下
2 │_Y _Y _G│
  └─────┘
```

#### 2.4.2 鋼鉄ブロックの動作例

```
初期状態:
    a b c
  ┌─────┐
0 │_R ■  _B│  _R: 赤の通常ブロック
1 │_R _B _B│  ■ : 鋼鉄ブロック
2 │_Y _Y _G│  _B: 青の通常ブロック
  └─────┘  _Y: 黄の通常ブロック
             _G: 緑の通常ブロック

ケース1: 通常操作での消去試行
    a b c
  ┌─────┐
0 │_R ■  _B│  鋼鉄ブロックは通常操作では消去できない
1 │_R _B _B│  隣接する赤ブロックを選択しても、鋼鉄ブロックは
2 │_Y _Y _G│  グループ形成に参加しない
  └─────┘

結果: 鋼鉄ブロックは消去されず、赤ブロックのみ消去される
    a b c
  ┌─────┐
0 │   ■  _B│
1 │   _B _B│
2 │_Y _Y _G│
  └─────┘

ケース2: 鋼鉄ハンマーアイテムの使用
    a b c
  ┌─────┐
0 │_R _B  _B│  鋼鉄ハンマーアイテムを鋼鉄ブロックに使用
1 │_R ■ _B│
2 │_Y _Y _G│
  └─────┘

結果: 鋼鉄ブロックが消去される
    a b c
  ┌─────┐
0 │_R    _B│
1 │_R _B _B│
2 │_Y _Y _G│
  └─────┘

ケース3: 重力の影響
    a b c
  ┌─────┐
0 │_R ■  _B│
1 │_R _B _B│  位置(a,0)の赤ブロックを消去
2 │_Y _Y _G│
  └─────┘

結果: 鋼鉄ブロックは重力の影響を受けない（固定位置）
    a b c
  ┌─────┐
0 │_R ■    │  鋼鉄ブロックは移動しない
1 │_R      │
2 │_Y _Y _G│
  └─────┘
```

## 3. 実装ルール

### 3.1 データ構造

- 妨害ブロックは `Block` インターフェースを実装し、`type` プロパティで種類を区別する
- 妨害ブロックの状態は `ObstacleBlock` クラスで管理する
- 各妨害ブロックタイプは `ObstacleBlock` を継承した具象クラスとして実装する

### 3.2 描画ルール

- 妨害ブロックは単一のエンティティとして描画する
- 「基本ブロック + オーバーレイ」という表現は使用しない
- 色と特殊効果（氷、カウンターなど）は単一のブロック内に統合する

### 3.3 色の表現

- 妨害ブロックの色は、ブロック自体の色として表現する
- 氷結ブロックの場合は、元の色と氷の青色をブレンドして表現する
- 色を示す小さな円などの別オブジェクトは使用しない

### 3.4 状態変化

- 妨害ブロックの状態変化（例：氷結 Lv2→Lv1）は、ブロック全体の変化として表現する
- 状態変化時は新しい `ObstacleBlock` インスタンスを作成する

## 4. デバッグと検証

### 4.1 アスキーアート表示

- 妨害ブロックの配置と種類をアスキーアートで可視化する
- 各ブロックタイプと色を記号で表現し、グリッド形式で出力する

### 4.2 検証ポイント

- 同じマスに複数のブロックが存在していないか
- 妨害ブロックが正しく単一のエンティティとして描画されているか
- 状態変化が正しく処理されているか

## 5. 注意事項

### 5.1 避けるべき実装

- 妨害ブロックの下に通常ブロックを配置する実装
- 半透明のオーバーレイとして妨害効果を表現する実装
- 複数のレイヤーを重ねて妨害ブロックを表現する実装

### 5.2 推奨される実装

- 単一のブロックとして妨害ブロックを表現する実装
- 色と特殊効果を統合した視覚表現
- 明確な状態管理と状態変化の処理

## 1.4 ブロック連結判定の詳細ルール

### 1.4.1 氷結ブロックの連結判定

- **通過可能性**: 氷結ブロック（氷結Lv1、氷結Lv2、氷結カウンター、氷結カウンター+）は同色ブロックの連結判定において「通過可能」である
- **例**: 「赤ブロック→氷結(赤)ブロック→赤ブロック」という配置では、両端の赤ブロックは同じグループとして扱われる
- **消去対象外**: 氷結ブロック自体は連結グループに含まれず、消去対象にはならない
- **視覚的表現**: 連結判定時に氷結ブロックを通過する場合も、氷結ブロックはハイライト表示されない

### 1.4.2 カウンターブロックの連結判定

- **グループ参加**: カウンターブロック（カウンター、カウンター+）は同色ブロックのグループ形成に参加する
- **消去条件**: カウンターブロックは指定された条件（ちょうど指定数、または指定数以上）を満たす場合のみ消去される
- **例**: 「赤ブロック→カウンター(赤)ブロック→赤ブロック」という配置では、全てのブロックが同じグループとして扱われる
- **視覚的表現**: 連結判定時にカウンターブロックもハイライト表示される

### 1.4.3 氷結カウンターブロックの連結判定

- **通過のみ**: 氷結カウンターブロック（氷結カウンター、氷結カウンター+）は氷結ブロックと同様に「通過可能」だが、グループには含まれない
- **例**: 「赤ブロック→氷結カウンター(赤)ブロック→赤ブロック」という配置では、両端の赤ブロックは同じグループとして扱われる
- **解除後の挙動**: 氷結が解除されてカウンターブロックになった場合は、カウンターブロックの連結判定ルールに従う
- **視覚的表現**: 連結判定時に氷結カウンターブロックを通過する場合も、氷結カウンターブロックはハイライト表示されない

### 1.4.4 連結判定の実装例

```
初期状態:
    a b c d e
  ┌─────────┐
0 │_R ❄R _R ❄cR _R│  _R: 赤の通常ブロック
1 │_B _B _B _B _B│  ❄R: 赤の氷結Lv1ブロック
2 │_Y _Y _G _G _G│  ❄cR: 赤の氷結カウンターブロック
  └─────────┘  _B: 青の通常ブロック
                  _Y: 黄の通常ブロック
                  _G: 緑の通常ブロック

連結判定:
位置(a,0)の赤ブロックをタップした場合、連結グループは以下のようになる:
- 位置(a,0)の赤ブロック: グループに含まれる
- 位置(b,0)の氷結赤ブロック: グループに含まれない（通過のみ）
- 位置(c,0)の赤ブロック: グループに含まれる
- 位置(d,0)の氷結カウンター赤ブロック: グループに含まれない（通過のみ）
- 位置(e,0)の赤ブロック: グループに含まれる

結果: 3つの赤ブロック(a,0), (c,0), (e,0)が同じグループとして扱われ、消去される
氷結ブロックと氷結カウンターブロックは通過のみで、グループには含まれない
```
