# アイテム選択画面 実装TODO

## 🎨 レイアウト設計（最優先）

### 画面構成の基本方針
```
画面サイズ: 400px × 710px（スマホ縦画面）
レイアウト: 固定レイアウト（スクロールエリア以外）
```

### エリア分割
```
┌─────────────────────────┐ ← 0px
│ タイトル                │
├─────────────────────────┤ ← 60px
│ 特殊枠    │   通常枠    │ ← 左右配置
│(S〜Fレア) │ (B〜Fレア)  │
├─────────────────────────┤ ← 120px
│ アイテム一覧タイトル    │
├─────────────────────────┤ ← 160px
│                         │
│   スクロールエリア      │ ← マスク適用エリア
│   （アイテムリスト）    │
│                         │
├─────────────────────────┤ ← 630px
│ 決定・キャンセルボタン  │
└─────────────────────────┘ ← 710px
```

### 詳細レイアウト仕様

#### 1. ヘッダーエリア（0px - 120px）
```typescript
const HEADER_LAYOUT = {
  title: {
    y: 30,
    height: 30,
    fontSize: '20px'
  },
  equipSlots: {
    y: 90,
    height: 50,
    specialSlot: {
      x: 100, // 左側
      width: 180,
      label: '◆特殊枠（S〜Fレア用）',
      color: '#FFD700' // 金色
    },
    normalSlot: {
      x: 300, // 右側
      width: 180,
      label: '◆通常枠（B〜Fレア用）',
      color: '#CCCCCC' // 銀色
    }
  }
};
```

#### 2. アイテムリストエリア（120px - 630px）
```typescript
const ITEM_LIST_LAYOUT = {
  titleArea: {
    y: 140,
    height: 20,
    text: '◆所持アイテム一覧'
  },
  scrollArea: {
    startY: 160,
    endY: 630,
    height: 470, // 利用可能な高さ（60px増加）
    maskApplied: true
  },
  itemSpecs: {
    width: 340, // 画面幅 - 60px
    height: 60,
    spacing: 8,
    margin: 30 // 左右の余白
  }
};
```

#### 3. ボタンエリア（630px - 710px）
```typescript
const BUTTON_LAYOUT = {
  area: {
    y: 670, // 中央位置
    height: 80
  },
  buttons: {
    confirm: {
      x: 120, // 左側
      width: 100,
      height: 40,
      text: '決定',
      color: '#4CAF50'
    },
    cancel: {
      x: 280, // 右側
      width: 100,
      height: 40,
      text: 'キャンセル',
      color: '#F44336'
    }
  }
};
```

### マスクエリアの正確な定義
```typescript
const MASK_AREA = {
  x: 0,
  y: 160, // アイテムリスト開始位置
  width: 400, // 画面全幅
  height: 470, // 630 - 160 = 470px
  
  // アイテム配置の基準点
  itemStartY: 180, // マスクエリア内の上部（20px余白）
  itemEndY: 610,   // マスクエリア内の下部（20px余白）
  
  // スクロール可能範囲
  maxVisibleItems: Math.floor(430 / 68), // (470-40) / (60+8) ≈ 6.3 → 6個
  scrollMargin: 20 // 上下の余白
};
```

### レイアウト実装の技術仕様

#### 座標系の統一
```typescript
// 基準座標の定義
const LAYOUT_CONSTANTS = {
  SCREEN_WIDTH: 400,
  SCREEN_HEIGHT: 710,
  
  // 各エリアの高さ
  TITLE_HEIGHT: 60,
  SLOT_AREA_HEIGHT: 60, // 特殊枠 + 通常枠（左右配置で高さ削減）
  ITEM_TITLE_HEIGHT: 40,
  SCROLL_AREA_HEIGHT: 470, // 60px増加
  BUTTON_AREA_HEIGHT: 80,
  
  // マージン設定
  SIDE_MARGIN: 30,
  ITEM_SPACING: 8,
  SAFE_MARGIN: 20
};
```

#### アイテム配置の計算式
```typescript
// アイテム位置の計算
const calculateItemPosition = (index: number) => {
  const baseY = LAYOUT_CONSTANTS.TITLE_HEIGHT + 
                LAYOUT_CONSTANTS.SLOT_AREA_HEIGHT + 
                LAYOUT_CONSTANTS.ITEM_TITLE_HEIGHT + 
                LAYOUT_CONSTANTS.SAFE_MARGIN;
  
  return {
    x: LAYOUT_CONSTANTS.SCREEN_WIDTH / 2,
    y: baseY + index * (60 + LAYOUT_CONSTANTS.ITEM_SPACING)
  };
};
```

#### スクロール範囲の計算
```typescript
// スクロール可能範囲の計算
const calculateScrollBounds = (itemCount: number) => {
  const totalContentHeight = itemCount * (60 + LAYOUT_CONSTANTS.ITEM_SPACING);
  const visibleHeight = LAYOUT_CONSTANTS.SCROLL_AREA_HEIGHT - (LAYOUT_CONSTANTS.SAFE_MARGIN * 2);
  
  return {
    maxScroll: Math.max(0, totalContentHeight - visibleHeight),
    visibleItemCount: Math.floor(visibleHeight / 68), // 約6個表示可能
    needsScroll: totalContentHeight > visibleHeight
  };
};
```

### レイアウト検証システム

#### 自動検証機能
```typescript
// レイアウトの整合性チェック
const validateLayout = () => {
  const totalHeight = 
    LAYOUT_CONSTANTS.TITLE_HEIGHT +
    LAYOUT_CONSTANTS.SLOT_AREA_HEIGHT +
    LAYOUT_CONSTANTS.ITEM_TITLE_HEIGHT +
    LAYOUT_CONSTANTS.SCROLL_AREA_HEIGHT +
    LAYOUT_CONSTANTS.BUTTON_AREA_HEIGHT;
  
  if (totalHeight !== LAYOUT_CONSTANTS.SCREEN_HEIGHT) {
    console.error('Layout height mismatch!', {
      calculated: totalHeight,
      expected: LAYOUT_CONSTANTS.SCREEN_HEIGHT
    });
  }
};
```

#### デバッグ表示の標準化
```typescript
// デバッグ表示の設定
const DEBUG_DISPLAY = {
  colors: {
    maskArea: 0x0000FF,    // 青：マスクエリア
    buttonArea: 0xFF0000,  // 赤：ボタンエリア
    itemStart: 0x00FF00,   // 緑：アイテム開始位置
    boundaries: 0x00FFFF   // 水色：境界線
  },
  lineWidth: 3,
  showCoordinates: true,
  showItemBounds: true
};
```

## ⚠️ 重要：繰り返し発生している問題と対策

### 🚨 絶対に避けるべき問題パターン

#### 1. **BitmapMaskの不正な動作**
**問題**: マスクが正常に動作せず、以下の症状が発生
- アイテムが完全に消える（見えなくなる）
- マスクが効かずに全アイテムが表示される
- マスクエリア外にアイテムがはみ出る

**根本原因**: 
- BitmapMaskの作成方法が不適切
- マスクグラフィックスの設定ミス
- マスクとコンテナの座標系の不一致

**絶対にやってはいけないこと**:
- マスクのデバッグのために一時的に無効化すること
- マスクグラフィックスのアルファ値を変更すること
- マスクエリアの座標を推測で設定すること

#### 2. **アイテムクリック不可問題**
**問題**: アイテムが表示されていてもクリックできない
**原因**: 
- インタラクションエリアの設定ミス
- 他の要素がクリックを阻害
- マスクによるインタラクション無効化

#### 3. **アイテム位置のずれ問題**
**問題**: アイテムの先頭が上にはみ出る、位置がおかしい
**原因**:
- itemStartYの計算ミス
- マスクエリア内の余白計算エラー
- コンテナの座標設定ミス

#### 4. **アイテム表示/非表示の不安定性**
**問題**: アイテムが表示されたり消えたりする
**原因**:
- visible/alphaプロパティの不適切な操作
- マスクの適用タイミングの問題
- デバッグコードの残存

### 🛡️ 確実な解決方針

#### Phase 1: 基本表示の確立（マスクなし）
1. **マスクを完全に使わずにアイテム表示を完璧にする**
2. **アイテムクリックを完全に動作させる**
3. **アイテム位置を正確に配置する**

#### Phase 2: マスク機能の慎重な実装
1. **基本表示が完璧に動作することを確認後にマスクを追加**
2. **マスクは最後の仕上げとして実装**
3. **マスク実装時は一切のデバッグ無効化を行わない**

### 📋 実装時の絶対ルール

#### ✅ やるべきこと
- アイテム表示を最優先で完璧にする
- マスクなしでの完全動作を確認する
- 段階的に機能を追加する
- 各段階で完全に動作することを確認する

#### ❌ 絶対にやってはいけないこと
- マスクのデバッグのための一時的無効化
- 推測による座標設定
- 複数の問題を同時に修正しようとすること
- デバッグコードを本番コードに混在させること

### 🎯 現在の最優先課題

**マスクを一切使わずに、アイテム選択画面の基本機能を完璧に動作させる**

1. アイテムの正常表示
2. アイテムのクリック機能
3. 装備システムの動作
4. スクロール機能の動作

**マスク機能は全ての基本機能が完璧に動作した後に実装する**

## 📊 現状分析（2025-06-08 14:24更新）

### ✅ 実装済み・正常動作
- **レイアウト設計**: item-select-scene-todo仕様に完全準拠 🎯
  - タイトル（Y=30）、装備スロット（Y=90）、アイテム一覧タイトル（Y=140）
  - マスクエリア（Y=160-630、470px）、ボタンエリア（Y=670）
- **装備スロット配置**: 左右配置に変更完了 ✅
  - 特殊枠（左側、X=100）、通常枠（右側、X=300）
- **装備スロットラベル**: 「S〜Fレア用」に修正完了 ✅
- **BitmapMask適用**: 視覚的なクリッピング機能 ✅
- **デバッグ表示**: レイアウト境界線、座標情報表示 ✅
- **レイアウト検証**: 高さ整合性チェック（710px）✅

### ❌ 未実装・問題のある機能
- **アイテム表示**: アイテムがマスクエリア内に表示されない 🚨
  - BitmapMaskは適用されているが、アイテムボタンが見えない状態
  - createItemButton関数は実行されているがUI上で非表示
- **スクロール機能**: アイテムが表示されないため動作確認不可 ⚠️
- **アイテム選択**: アイテムが見えないためタップ不可 ⚠️
- **装備システム**: アイテムの装備・解除ができない ❌
- **装備制限チェック**: レア度による制限が機能しない ❌
- **視覚的フィードバック**: 選択状態やエラーの表示なし ❌

### 🔍 スクリーンショット分析結果（14:24）
- **レイアウト**: 完璧に実装されている ✅
- **装備スロット**: 左右配置、正しいラベル表示 ✅
- **マスクエリア**: 青い枠で正確に表示されている ✅
- **ボタン配置**: 決定・キャンセルボタンが正しい位置 ✅
- **問題点**: アイテムリストが空白（アイテムボタンが非表示）🚨

## 🎯 実装要件（優先度順）

### 【最高優先度】Phase 1: アイテム表示の修正

#### 1.1 アイテム表示問題の解決 🚨
**現状**: アイテムボタンが作成されているが画面に表示されない
**目標**: 全アイテムがマスクエリア内で正常に表示される

**問題の詳細分析**:
- `createItemButton`関数は正常に実行されている
- `itemListContainer`にアイテムが追加されている
- BitmapMaskが適用されているが、アイテムが見えない状態
- デバッグログでは正常にアイテムが作成されている

**推定原因**:
1. **BitmapMaskの設定問題**: マスクの範囲やアルファ値の問題
2. **コンテナの位置問題**: itemListContainerの座標が不正
3. **アイテムの座標問題**: アイテムボタンの配置座標が不正
4. **レンダリング順序問題**: マスクとアイテムの描画順序

**実装内容**:
- [ ] BitmapMaskの設定を詳細に検証
- [ ] itemListContainerの座標とプロパティを確認
- [ ] アイテムボタンの実際の配置位置を検証
- [ ] マスクを一時的に無効化してアイテム表示を確認
- [ ] アイテムの可視性（visible, alpha）プロパティを確認

**技術要件**:
```typescript
// デバッグ用の詳細ログ追加
console.log('ItemListContainer state:', {
  x: this.itemListContainer.x,
  y: this.itemListContainer.y,
  visible: this.itemListContainer.visible,
  alpha: this.itemListContainer.alpha,
  childrenCount: this.itemListContainer.list.length,
  mask: this.itemListContainer.mask
});

// 各アイテムボタンの状態確認
this.itemListContainer.list.forEach((child, index) => {
  console.log(`Item ${index}:`, {
    x: child.x,
    y: child.y,
    visible: child.visible,
    alpha: child.alpha
  });
});
```

#### 1.2 スクロール機能の実装
**現状**: アイテムが表示されないためスクロール動作確認不可
**目標**: アイテム表示修正後にスクロール機能を完全実装

**実装内容**:
- [ ] マウスホイールによるスクロール
- [ ] タッチスクロール（モバイル対応）
- [ ] スクロール範囲の正確な計算
- [ ] スムーズなスクロールアニメーション
- [ ] スクロール位置の境界制限

#### 1.3 アイテム選択機能の実装
**現状**: アイテムが見えないためタップ不可
**目標**: アイテム表示修正後に選択機能を実装

**実装内容**:
- [ ] アイテムタップの検出
- [ ] 選択中アイテムのハイライト表示
- [ ] 装備スロット選択の実装
- [ ] 選択状態の管理

### 【高優先度】Phase 2: 装備システムの実装

#### 2.1 装備制限システムの実装
**現状**: 制限チェックが不完全
**目標**: 正確なレア度制限の実装

**実装内容**:
- [ ] レア度判定ロジック
- [ ] 特殊枠制限（S〜Fレア全て装備可能）
- [ ] 通常枠制限（B〜Fレア専用、S・Aレアは装備不可）
- [ ] エラーメッセージ表示

#### 2.2 視覚的フィードバックの実装
**目標**: ユーザーが現在の状態を理解できる

**実装内容**:
- [ ] 選択中スロットのハイライト（枠線の色変更）
- [ ] 装備済みアイテムの表示更新
- [ ] 選択中アイテムの強調表示
- [ ] ホバー効果（PC版）

### 【中優先度】Phase 3: UX改善

#### 3.1 エラーハンドリングの実装
**目標**: 分かりやすいエラーメッセージ

**実装内容**:
- [ ] 装備制限エラーの表示
- [ ] スロット未選択エラーの表示
- [ ] 一時的なメッセージ表示システム
- [ ] エラーメッセージの自動消去

#### 3.2 装備解除機能の実装
**目標**: 装備したアイテムの取り外し

**実装内容**:
- [ ] 装備済みスロットのタップ検出
- [ ] 装備解除の確認ダイアログ
- [ ] 装備解除後の表示更新

## 🔧 技術的課題と解決方針

### 課題1: スクロール機能の実装
**問題**: 現在のスクロール実装が動作しない
**原因**: イベントハンドリングとコンテナ位置更新の不整合
**解決方針**: シンプルなwheel/touchイベントベースの実装

### 課題2: マスクとインタラクションの両立
**問題**: マスクエリア外のアイテムクリック制御
**原因**: 視覚的マスクと論理的インタラクション制御の不一致
**解決方針**: BitmapMaskと手動インタラクション制御の併用

### 課題3: 装備状態の管理
**問題**: 装備状態とUI表示の同期
**解決方針**: 状態管理オブジェクトとUI更新関数の分離

## 📅 実装スケジュール

### Week 1: Phase 1 実装
- Day 1-2: スクロール機能修正
- Day 3-4: アイテム選択機能実装
- Day 5: 装備制限システム実装

### Week 2: Phase 2 実装
- Day 1-2: 視覚的フィードバック実装
- Day 3-4: エラーハンドリング実装
- Day 5: 装備解除機能実装

### Week 3: Phase 3 実装
- Day 1-3: 操作性向上とアニメーション
- Day 4-5: パフォーマンス最適化とテスト

## 🧪 テスト要件

### 機能テスト
- [ ] 全アイテムのスクロール表示
- [ ] 装備制限の正確性
- [ ] エラーケースの処理
- [ ] 装備・解除の動作

### UXテスト
- [ ] 操作の直感性
- [ ] エラーメッセージの分かりやすさ
- [ ] レスポンシブ対応

### パフォーマンステスト
- [ ] 大量アイテム時の動作
- [ ] スクロール時のフレームレート
- [ ] メモリ使用量

## 📝 実装時の注意点

### コード品質
- TypeScriptの型安全性を活用
- 関数の単一責任原則を守る
- 適切なコメントとログ出力

### ユーザビリティ
- 操作フローの一貫性
- エラー時の適切なガイダンス
- アクセシビリティへの配慮

### 保守性
- 設定値の外部化
- 再利用可能なコンポーネント設計
- 十分なテストカバレッジ

## 🎯 成功指標

### 機能面
- [ ] 全アイテムが問題なくスクロール表示される
- [ ] 装備制限が100%正確に動作する
- [ ] エラーケースが適切に処理される

### UX面
- [ ] 初回ユーザーが迷わず操作できる
- [ ] エラー時に適切なガイダンスが表示される
- [ ] 操作が直感的で快適

### 技術面
- [ ] 60FPSでスムーズに動作する
- [ ] メモリリークが発生しない
- [ ] 異なるデバイスで一貫した動作
